<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scale-Aware Note Generation Demo</title>
    <script src="https://unpkg.com/tone@14.7.77/build/Tone.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .demo-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .control-group {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .control-group h3 {
            margin-top: 0;
            margin-bottom: 15px;
            color: #ffd700;
        }
        
        .control {
            margin-bottom: 15px;
        }
        
        .control label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .control select,
        .control input[type="range"] {
            width: 100%;
            padding: 8px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 14px;
        }
        
        .control input[type="range"] {
            height: 6px;
            background: linear-gradient(to right, #667eea, #764ba2);
            outline: none;
        }
        
        .control input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ffd700;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        
        .value-display {
            font-size: 12px;
            color: #ffd700;
            margin-top: 5px;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            margin: 25px 0;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn.primary {
            background: linear-gradient(45deg, #4ecdc4, #44a08d);
        }
        
        .btn.secondary {
            background: linear-gradient(45deg, #a8edea, #fed6e3);
            color: #333;
        }
        
        .info-panel {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .info-panel h3 {
            margin-top: 0;
            color: #ffd700;
        }
        
        .scale-notes {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .note {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: 15px;
            font-family: monospace;
            font-weight: bold;
        }
        
        .chord-progression {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .chord {
            background: linear-gradient(45deg, #ff9a9e, #fecfef);
            color: #333;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            text-align: center;
            min-width: 60px;
        }
        
        .status {
            text-align: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin: 20px 0;
            font-weight: 500;
        }
        
        .status.playing {
            background: rgba(76, 175, 80, 0.3);
            border: 1px solid rgba(76, 175, 80, 0.5);
        }
        
        .status.error {
            background: rgba(244, 67, 54, 0.3);
            border: 1px solid rgba(244, 67, 54, 0.5);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéµ Scale-Aware Note Generation Demo</h1>
        
        <div class="demo-section">
            <div class="controls-grid">
                <div class="control-group">
                    <h3>üéº Scale & Key</h3>
                    <div class="control">
                        <label for="scaleAwareEnabled">Scale-Aware Generation</label>
                        <select id="scaleAwareEnabled">
                            <option value="false">Off</option>
                            <option value="true">On</option>
                        </select>
                    </div>
                    <div class="control">
                        <label for="musicalKey">Key</label>
                        <select id="musicalKey">
                            <option value="C">C</option>
                            <option value="C#">C#</option>
                            <option value="Db">Db</option>
                            <option value="D">D</option>
                            <option value="D#">D#</option>
                            <option value="Eb">Eb</option>
                            <option value="E">E</option>
                            <option value="F">F</option>
                            <option value="F#">F#</option>
                            <option value="Gb">Gb</option>
                            <option value="G">G</option>
                            <option value="G#">G#</option>
                            <option value="Ab">Ab</option>
                            <option value="A">A</option>
                            <option value="A#">A#</option>
                            <option value="Bb">Bb</option>
                            <option value="B">B</option>
                        </select>
                    </div>
                    <div class="control">
                        <label for="musicalScale">Scale</label>
                        <select id="musicalScale">
                            <option value="major">Major</option>
                            <option value="minor">Natural Minor</option>
                            <option value="harmonic_minor">Harmonic Minor</option>
                            <option value="melodic_minor">Melodic Minor</option>
                            <option value="dorian">Dorian</option>
                            <option value="phrygian">Phrygian</option>
                            <option value="lydian">Lydian</option>
                            <option value="mixolydian">Mixolydian</option>
                            <option value="locrian">Locrian</option>
                            <option value="pentatonic_major">Pentatonic Major</option>
                            <option value="pentatonic_minor">Pentatonic Minor</option>
                            <option value="blues">Blues Scale</option>
                            <option value="chromatic">Chromatic</option>
                        </select>
                    </div>
                </div>
                
                <div class="control-group">
                    <h3>üé® Style & Mood</h3>
                    <div class="control">
                        <label for="generationStyle">Generation Style</label>
                        <select id="generationStyle">
                            <option value="classical">Classical</option>
                            <option value="jazz">Jazz</option>
                            <option value="pop">Pop</option>
                            <option value="electronic">Electronic</option>
                        </select>
                    </div>
                    <div class="control">
                        <label for="musicalMood">Musical Mood</label>
                        <select id="musicalMood">
                            <option value="balanced">Balanced</option>
                            <option value="happy">Happy</option>
                            <option value="sad">Sad</option>
                            <option value="energetic">Energetic</option>
                            <option value="calm">Calm</option>
                            <option value="mysterious">Mysterious</option>
                            <option value="dramatic">Dramatic</option>
                        </select>
                    </div>
                </div>
                
                <div class="control-group">
                    <h3>‚öôÔ∏è Complexity</h3>
                    <div class="control">
                        <label for="harmonicComplexity">Harmonic Complexity</label>
                        <input type="range" id="harmonicComplexity" min="0" max="1" step="0.01" value="0.6">
                        <div class="value-display" id="harmonicComplexityValue">60%</div>
                    </div>
                    <div class="control">
                        <label for="melodicComplexity">Melodic Complexity</label>
                        <input type="range" id="melodicComplexity" min="0" max="1" step="0.01" value="0.5">
                        <div class="value-display" id="melodicComplexityValue">50%</div>
                    </div>
                    <div class="control">
                        <label for="rhythmComplexity">Rhythm Complexity</label>
                        <input type="range" id="rhythmComplexity" min="0" max="1" step="0.01" value="0.5">
                        <div class="value-display" id="rhythmComplexityValue">50%</div>
                    </div>
                </div>
            </div>
            
            <div class="button-group">
                <button class="btn primary" id="startBtn">‚ñ∂Ô∏è Start</button>
                <button class="btn" id="stopBtn">‚èπÔ∏è Stop</button>
                <button class="btn secondary" id="generateBtn">üé≤ Generate New</button>
                <button class="btn secondary" id="randomizeBtn">üé≤ Randomize All</button>
            </div>
            
            <div class="status" id="status">Ready to start</div>
        </div>
        
        <div class="demo-section">
            <h3>üéµ Current Scale Information</h3>
            <div class="info-panel">
                <h4>Scale Notes:</h4>
                <div class="scale-notes" id="scaleNotes">
                    <!-- Scale notes will be populated here -->
                </div>
            </div>
        </div>
        
        <div class="demo-section">
            <h3>üéº Chord Progression</h3>
            <div class="info-panel">
                <div class="chord-progression" id="chordProgression">
                    <!-- Chord progression will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import the scale-aware modules
        import { ScaleKeyManager } from './modules/scale-key-manager.js';
        import { NoteGenerationEngine } from './modules/note-generation-engine.js';
        import { ChordProgressionManager } from './modules/chord-progression-manager.js';
        import { MelodyGenerator } from './modules/melody-generator.js';

        class ScaleGenerationDemo {
            constructor() {
                this.scaleKeyManager = new ScaleKeyManager();
                this.noteGenerationEngine = new NoteGenerationEngine(this.scaleKeyManager);
                this.chordProgressionManager = new ChordProgressionManager(this.scaleKeyManager);
                this.melodyGenerator = new MelodyGenerator(this.scaleKeyManager);
                
                this.isPlaying = false;
                this.audioContext = null;
                this.sequences = null;
                
                this.initializeUI();
                this.setupEventListeners();
                this.updateDisplay();
            }

            initializeUI() {
                // Initialize UI elements
                this.elements = {
                    scaleAwareEnabled: document.getElementById('scaleAwareEnabled'),
                    musicalKey: document.getElementById('musicalKey'),
                    musicalScale: document.getElementById('musicalScale'),
                    generationStyle: document.getElementById('generationStyle'),
                    musicalMood: document.getElementById('musicalMood'),
                    harmonicComplexity: document.getElementById('harmonicComplexity'),
                    melodicComplexity: document.getElementById('melodicComplexity'),
                    rhythmComplexity: document.getElementById('rhythmComplexity'),
                    startBtn: document.getElementById('startBtn'),
                    stopBtn: document.getElementById('stopBtn'),
                    generateBtn: document.getElementById('generateBtn'),
                    randomizeBtn: document.getElementById('randomizeBtn'),
                    status: document.getElementById('status'),
                    scaleNotes: document.getElementById('scaleNotes'),
                    chordProgression: document.getElementById('chordProgression')
                };

                // Initialize value displays
                this.updateValueDisplays();
            }

            setupEventListeners() {
                // Scale and key controls
                this.elements.scaleAwareEnabled.addEventListener('change', () => this.updateSettings());
                this.elements.musicalKey.addEventListener('change', () => this.updateSettings());
                this.elements.musicalScale.addEventListener('change', () => this.updateSettings());
                this.elements.generationStyle.addEventListener('change', () => this.updateSettings());
                this.elements.musicalMood.addEventListener('change', () => this.updateSettings());

                // Complexity sliders
                this.elements.harmonicComplexity.addEventListener('input', () => this.updateValueDisplays());
                this.elements.melodicComplexity.addEventListener('input', () => this.updateValueDisplays());
                this.elements.rhythmComplexity.addEventListener('input', () => this.updateValueDisplays());

                // Buttons
                this.elements.startBtn.addEventListener('click', () => this.start());
                this.elements.stopBtn.addEventListener('click', () => this.stop());
                this.elements.generateBtn.addEventListener('click', () => this.generateNew());
                this.elements.randomizeBtn.addEventListener('click', () => this.randomizeAll());
            }

            updateSettings() {
                const key = this.elements.musicalKey.value;
                const scale = this.elements.musicalScale.value;
                const style = this.elements.generationStyle.value;
                const mood = this.elements.musicalMood.value;
                const enabled = this.elements.scaleAwareEnabled.value === 'true';

                // Update scale and key
                this.scaleKeyManager.setKey(key);
                this.scaleKeyManager.setScale(scale);

                // Update generation settings
                this.noteGenerationEngine.updateSettings({
                    octaveRange: { min: 3, max: 5 },
                    noteDensity: parseFloat(this.elements.melodicComplexity.value),
                    rhythmComplexity: parseFloat(this.elements.rhythmComplexity.value),
                    harmonicComplexity: parseFloat(this.elements.harmonicComplexity.value),
                    melodicContour: this.getMelodicContourFromMood(mood)
                });

                this.updateDisplay();
            }

            updateValueDisplays() {
                this.elements.harmonicComplexityValue.textContent = 
                    Math.round(parseFloat(this.elements.harmonicComplexity.value) * 100) + '%';
                this.elements.melodicComplexityValue.textContent = 
                    Math.round(parseFloat(this.elements.melodicComplexity.value) * 100) + '%';
                this.elements.rhythmComplexityValue.textContent = 
                    Math.round(parseFloat(this.elements.rhythmComplexity.value) * 100) + '%';
            }

            getMelodicContourFromMood(mood) {
                const moodContours = {
                    'happy': 'ascending',
                    'sad': 'descending',
                    'energetic': 'random',
                    'calm': 'balanced',
                    'mysterious': 'valley',
                    'dramatic': 'arch'
                };
                return moodContours[mood] || 'balanced';
            }

            updateDisplay() {
                // Update scale notes display
                const scaleNotes = this.scaleKeyManager.getScaleNotesRange(3, 5);
                this.elements.scaleNotes.innerHTML = scaleNotes.map(note => 
                    `<span class="note">${note}</span>`
                ).join('');

                // Update chord progression display
                const progression = this.chordProgressionManager.generateProgression(4, 
                    this.elements.generationStyle.value, 
                    this.elements.musicalMood.value
                );
                this.elements.chordProgression.innerHTML = progression.map(chord => 
                    `<div class="chord">${chord.symbol}</div>`
                ).join('');
            }

            async start() {
                try {
                    if (!this.audioContext) {
                        this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    }

                    if (this.audioContext.state === 'suspended') {
                        await this.audioContext.resume();
                    }

                    this.isPlaying = true;
                    this.elements.status.textContent = 'Playing...';
                    this.elements.status.className = 'status playing';
                    this.elements.startBtn.disabled = true;
                    this.elements.stopBtn.disabled = false;

                    // Start a simple demonstration
                    this.playDemo();
                } catch (error) {
                    console.error('Error starting audio:', error);
                    this.elements.status.textContent = 'Error starting audio';
                    this.elements.status.className = 'status error';
                }
            }

            stop() {
                this.isPlaying = false;
                this.elements.status.textContent = 'Stopped';
                this.elements.status.className = 'status';
                this.elements.startBtn.disabled = false;
                this.elements.stopBtn.disabled = true;

                // Stop any playing sequences
                if (this.sequences) {
                    this.sequences.forEach(seq => seq.stop());
                }
            }

            generateNew() {
                this.updateSettings();
                this.elements.status.textContent = 'Generated new patterns';
                this.elements.status.className = 'status';
            }

            randomizeAll() {
                // Randomize all settings
                const keys = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                const scales = ['major', 'minor', 'harmonic_minor', 'dorian', 'phrygian', 'lydian', 'mixolydian', 'pentatonic_major', 'pentatonic_minor', 'blues'];
                const styles = ['classical', 'jazz', 'pop', 'electronic'];
                const moods = ['balanced', 'happy', 'sad', 'energetic', 'calm', 'mysterious', 'dramatic'];

                this.elements.musicalKey.value = keys[Math.floor(Math.random() * keys.length)];
                this.elements.musicalScale.value = scales[Math.floor(Math.random() * scales.length)];
                this.elements.generationStyle.value = styles[Math.floor(Math.random() * styles.length)];
                this.elements.musicalMood.value = moods[Math.floor(Math.random() * moods.length)];
                this.elements.harmonicComplexity.value = Math.random();
                this.elements.melodicComplexity.value = Math.random();
                this.elements.rhythmComplexity.value = Math.random();

                this.updateValueDisplays();
                this.updateSettings();
                this.elements.status.textContent = 'Randomized all settings';
                this.elements.status.className = 'status';
            }

            playDemo() {
                // Simple demonstration - play scale notes
                const scaleNotes = this.scaleKeyManager.getScaleNotes(4);
                let noteIndex = 0;

                const playNextNote = () => {
                    if (!this.isPlaying || noteIndex >= scaleNotes.length) {
                        if (this.isPlaying) {
                            noteIndex = 0; // Loop
                            setTimeout(playNextNote, 1000);
                        }
                        return;
                    }

                    const note = scaleNotes[noteIndex];
                    this.playNote(note, 0.5);
                    noteIndex++;
                    setTimeout(playNextNote, 500);
                };

                playNextNote();
            }

            playNote(note, duration) {
                if (!this.audioContext) return;

                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);

                // Convert note to frequency
                const frequency = this.noteToFrequency(note);
                oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);

                // Set envelope
                gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.3, this.audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + duration);

                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + duration);
            }

            noteToFrequency(note) {
                const noteMap = {
                    'C': 0, 'C#': 1, 'Db': 1, 'D': 2, 'D#': 3, 'Eb': 3, 'E': 4, 'F': 5,
                    'F#': 6, 'Gb': 6, 'G': 7, 'G#': 8, 'Ab': 8, 'A': 9, 'A#': 10, 'Bb': 10, 'B': 11
                };

                const match = note.match(/^([A-G]#?b?)(\d+)$/);
                if (!match) return 440;

                const [, noteName, octave] = match;
                const noteNumber = noteMap[noteName];
                const octaveNumber = parseInt(octave);

                return 440 * Math.pow(2, (noteNumber + (octaveNumber - 4) * 12) / 12);
            }
        }

        // Initialize the demo when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new ScaleGenerationDemo();
        });
    </script>
</body>
</html>